---
import type { GetStaticPaths } from 'astro';
import { getCollection, getEntry } from 'astro:content';

import { InfinitePostList } from '@/components/InfinitePostList';
import { defaultLang } from '@/i18n/ui';
import { useTranslations, generateHreflangs } from '@/i18n/utils';
import Layout from '@/layouts/Layout.astro';
import { BreadcrumbLd, CollectionPageLd } from '@/lib/rich-results';
import { blogToUnified, sortUnifiedPosts } from '@/types/unified-post';

export const getStaticPaths: GetStaticPaths = async () => {
  const allPosts = await getCollection('blog');
  const publishedPosts = allPosts.filter((post) => post.data.isPublished);

  const tags = [
    ...new Set(publishedPosts.flatMap((post) => post.data.tags ?? [])),
  ];

  return tags.map((tag) => ({
    params: { tag },
  }));
};

const { tag } = Astro.params;
if (!tag || typeof tag !== 'string') {
  return Astro.redirect('/404');
}
const lang = defaultLang;
const t = useTranslations(lang);
const site = Astro.site ?? '';
const meta = await getEntry('site', 'meta');
if (!meta) {
  throw new Error('Site meta configuration not found');
}
const basePath = `blog/tags/${tag}`;
const pageUrl = new URL(`/${basePath}`, site).toString();
const homeUrl = new URL('/', site).toString();
const blogUrl = new URL('/blog', site).toString();

// Fetch and filter posts for this tag
const allPosts = await getCollection('blog');
const tagPosts = allPosts
  .filter((post) => post.data.isPublished && post.data.tags?.includes(tag))
  .map(blogToUnified);

const sortedPosts = sortUnifiedPosts(tagPosts);

// Serialize posts for client-side component
const serializedPosts = sortedPosts.map((post) => ({
  type: post.type,
  slug: post.slug,
  title: post.title,
  description: post.originalPost?.data.description,
  date: post.date.toISOString(),
  lastUpdated: post.lastUpdated?.toISOString(),
  category: post.category,
  tags: post.tags,
  url: post.url,
}));
---

<Layout
  title={`タグ: #${tag} | ${t('main.title')}`}
  description={t('tags.description')}
  path={`/blog/tags/${tag}`}
  lang={lang}
  og={{
    enabled: true,
  }}
  hreflangs={generateHreflangs(basePath)}
  jsonLdSchema={[
    CollectionPageLd({
      name: `#${tag}`,
      description: t('tags.description'),
      url: pageUrl,
      meta,
      site,
    }),
    BreadcrumbLd([
      { name: t('main.title'), url: homeUrl },
      { name: t('blog.index'), url: blogUrl },
      { name: `#${tag}`, url: pageUrl },
    ]),
  ]}
>
  <div>
    <InfinitePostList
      client:load
      initialPosts={serializedPosts}
      title={`#${tag}`}
    />
  </div>
</Layout>
