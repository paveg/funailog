---
import { getCollection } from 'astro:content';

import { InfinitePostList } from '@/components/InfinitePostList';
import { defaultLang } from '@/i18n/ui';
import { useTranslations, generateHreflangs } from '@/i18n/utils';
import Layout from '@/layouts/Layout.astro';
import { fetchZennArticles } from '@/lib/zenn';
import {
  blogToUnified,
  zennToUnified,
  sortUnifiedPosts,
} from '@/types/unified-post';

const lang = defaultLang;
const t = useTranslations(lang);

// Fetch blog posts
const blogPosts = (await getCollection('blog'))
  .filter((post) => post.data.isPublished)
  .filter((post) => {
    const [postLang] = post.slug.split('/');
    return postLang === defaultLang;
  })
  .map(blogToUnified);

// Fetch Zenn articles
const zennArticles = (await fetchZennArticles()).map(zennToUnified);

// Merge and sort all posts
const allPosts = sortUnifiedPosts([...blogPosts, ...zennArticles]);

// Serialize posts for client-side component
const serializedPosts = allPosts.map((post) => ({
  type: post.type,
  slug: post.slug,
  title: post.title,
  description:
    post.type === 'blog' ? post.originalPost?.data.description : undefined,
  date: post.date.toISOString(),
  lastUpdated: post.lastUpdated?.toISOString(),
  category: post.category,
  tags: post.tags,
  url: post.url,
  emoji: post.emoji,
  likedCount: post.likedCount,
  commentsCount: post.commentsCount,
  articleType: post.articleType,
}));
---

<Layout
  title={`${t('blog.index')} | ${t('main.title')}`}
  description={t('blog.description')}
  path="/blog"
  lang={lang}
  og={{
    enabled: true,
  }}
  hreflangs={generateHreflangs('blog')}
>
  <main>
    <div class="flex items-center justify-between py-4">
      <h1 class="font-heading capitalize">{t('blog.index')}</h1>
    </div>
    <InfinitePostList client:load initialPosts={serializedPosts} />
  </main>
</Layout>
