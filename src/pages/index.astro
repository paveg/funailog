---
import { getCollection, getEntry } from 'astro:content';

import PostCard from '@/components/PostCard.astro';
import { useTranslations, generateHreflangs } from '@/i18n/utils';
import Layout from '@/layouts/Layout.astro';
import { WebsiteLd } from '@/lib/rich-results';
import { blogToUnified, sortUnifiedPosts } from '@/types/unified-post';

const t = useTranslations('ja');
const site = Astro.site ?? '';
const meta = await getEntry('site', 'meta');
if (!meta) {
  throw new Error('Site meta configuration not found');
}

// 最新記事5件を取得
const blogPosts = (await getCollection('blog'))
  .filter((post) => post.data.isPublished)
  .map(blogToUnified);

const recentPosts = sortUnifiedPosts(blogPosts).slice(0, 5);
const featuredPost = recentPosts[0];
const otherPosts = recentPosts.slice(1);
---

<Layout
  title={t('main.title')}
  description={t('main.description')}
  path="/"
  og={{
    enabled: true,
  }}
  hreflangs={generateHreflangs('')}
  jsonLdSchema={WebsiteLd(meta, site)}
>
  <div class="space-y-12 py-8">
    <!-- ヒーローセクション -->
    <section
      class="flex flex-col items-center gap-6 text-center md:flex-row md:text-left"
    >
      <div class="shrink-0">
        <img
          src="/profile.jpg"
          alt={meta.data.author.name}
          class="size-24 rounded-full object-cover shadow-md md:size-28"
          loading="eager"
        />
      </div>
      <div class="space-y-3">
        <h1 class="font-heading text-2xl md:text-3xl">{t('main.title')}</h1>
        <p class="text-muted-foreground text-lg font-medium">
          買わない後悔のほうがきっと大きい
        </p>
        <p class="text-muted-foreground max-w-lg text-sm leading-relaxed">
          ガジェット・仕事道具・乗り物、そして技術についても綴る個人メディア。<br
            class="hidden sm:inline"
          />シンプルで気分を上げるモノやエンジニアリングの知見を紹介しています。
        </p>
      </div>
    </section>

    <!-- 最新記事セクション -->
    <section>
      <h2 class="font-heading mb-6 text-lg">最新の記事</h2>

      {/* Featured post - Card style if has heroImage */}
      {
        featuredPost && (
          <div class="mb-6">
            <PostCard post={featuredPost} variant="card" />
          </div>
        )
      }

      {/* Other posts - List style */}
      <ul class="space-y-5">
        {
          otherPosts.map((post) => (
            <li>
              <PostCard post={post} variant="list" />
            </li>
          ))
        }
      </ul>

      <div class="mt-8">
        <a
          href="/blog"
          class="group font-code text-muted-foreground hover:text-foreground inline-flex items-center gap-1.5 text-xs transition-colors"
        >
          すべての記事を見る
          <span class="transition-transform group-hover:translate-x-0.5"
            >&rarr;</span
          >
        </a>
      </div>
    </section>
  </div>
</Layout>
