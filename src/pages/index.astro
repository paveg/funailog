---
import { getCollection, getEntry } from 'astro:content';

import { ArrowRightIcon, CalendarIcon } from '@radix-ui/react-icons';

import { Badge } from '@/components/ui/badge';
import { defaultLang } from '@/i18n/ui';
import { useTranslations, generateHreflangs } from '@/i18n/utils';
import Layout from '@/layouts/Layout.astro';
import { WebsiteLd } from '@/lib/rich-results';
import { fetchZennArticles } from '@/lib/zenn';
import {
  blogToUnified,
  zennToUnified,
  sortUnifiedPosts,
} from '@/types/unified-post';

const t = useTranslations('ja');
const site = Astro.site ?? '';
const meta = await getEntry('site', 'meta');
if (!meta) {
  throw new Error('Site meta configuration not found');
}

// 最新記事5件を取得
const blogPosts = (await getCollection('blog'))
  .filter((post) => post.data.isPublished)
  .filter((post) => {
    const [postLang] = post.slug.split('/');
    return postLang === defaultLang;
  })
  .map(blogToUnified);

const zennArticles = (await fetchZennArticles()).map(zennToUnified);
const recentPosts = sortUnifiedPosts([...blogPosts, ...zennArticles]).slice(
  0,
  5,
);

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('ja-JP', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  }).format(date);
}
---

<Layout
  title={t('main.title')}
  description={t('main.description')}
  path="/"
  og={{
    enabled: true,
  }}
  hreflangs={generateHreflangs('')}
  jsonLdSchema={WebsiteLd(meta, site)}
>
  <main class="space-y-12 py-8">
    <!-- ヒーローセクション -->
    <section
      class="flex flex-col items-center gap-6 text-center md:flex-row md:text-left"
    >
      <div class="shrink-0">
        <img
          src="/profile.jpg"
          alt={meta.data.author.name}
          class="size-24 rounded-full object-cover shadow-md md:size-28"
          loading="eager"
        />
      </div>
      <div class="space-y-3">
        <h1 class="font-heading text-2xl md:text-3xl">{t('main.title')}</h1>
        <p class="text-lg font-medium text-muted-foreground">
          買わない後悔のほうがきっと大きい
        </p>
        <p class="max-w-lg text-sm leading-relaxed text-muted-foreground">
          ガジェット・仕事道具・乗り物、そして技術についても綴る個人メディア。<br
            class="hidden sm:inline"
          />シンプルで気分を上げるモノやエンジニアリングの知見を紹介しています。
        </p>
      </div>
    </section>

    <!-- 最新記事セクション -->
    <section>
      <h2 class="mb-6 font-heading text-lg">最新の記事</h2>
      <ul class="space-y-5">
        {
          recentPosts.map((post) => {
            const isZenn = post.type === 'zenn';
            return (
              <li class="group">
                <a
                  href={post.url}
                  target={isZenn ? '_blank' : '_self'}
                  rel={isZenn ? 'noopener noreferrer' : undefined}
                  class="block"
                >
                  <div class="flex items-start gap-3">
                    <div class="flex-1">
                      <div class="mb-1 flex items-center gap-2">
                        {isZenn ? (
                          <Badge variant="outline" className="text-xs">
                            {post.emoji} Zenn
                          </Badge>
                        ) : (
                          <Badge
                            variant="secondary"
                            className="text-xs capitalize"
                          >
                            {post.category}
                          </Badge>
                        )}
                        <time
                          datetime={post.date.toISOString()}
                          class="flex items-center gap-1 text-xs text-muted-foreground"
                        >
                          <CalendarIcon className="size-3" />
                          {formatDate(post.date)}
                        </time>
                      </div>
                      <h3 class="font-heading text-foreground transition-colors duration-150 group-hover:text-link">
                        {post.title}
                      </h3>
                    </div>
                  </div>
                </a>
              </li>
            );
          })
        }
      </ul>

      <div class="mt-8">
        <a
          href="/blog"
          class="group inline-flex items-center gap-2 text-sm text-muted-foreground transition-colors hover:text-foreground"
        >
          すべての記事を見る
          <ArrowRightIcon
            className="size-4 transition-transform group-hover:translate-x-1"
          />
        </a>
      </div>
    </section>
  </main>
</Layout>
