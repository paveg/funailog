---
title: React Query ã§å³åº§ã«UIåæ˜ ã™ã‚‹æ¥½è¦³çš„æ›´æ–° - CRUDå…¨ãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…ä¾‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
description: React Queryï¼ˆTanStack Queryï¼‰ã‚’ä½¿ã£ãŸæ¥½è¦³çš„æ›´æ–°ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã€Createãƒ»Updateãƒ»Deleteãƒ»ãƒã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ã®4ã¤ã®ã‚±ãƒ¼ã‚¹ã§è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãªã‚¢ãƒ—ãƒªé–‹ç™ºã«å¿…é ˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚‚ç´¹ä»‹ã€‚
published: 2026-01-03
tags:
  [
    'React Query',
    'TanStack Query',
    'TypeScript',
    'React Native',
    'ã‚­ãƒ£ãƒƒã‚·ãƒ¥',
    'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ',
  ]
isPublished: true
category: programming
---

[å‰å›ã®è¨˜äº‹](/blog/2025/modern-edge-tech-stack)ã§ã€React Queryï¼ˆTanStack Queryï¼‰ã‚’ä½¿ã£ãŸã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆè¨­è¨ˆã®**åŸºç¤æ¦‚å¿µ**ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ã€ãã®**å®Ÿè£…ã®ç´°éƒ¨**ã‚’æ·±æ˜ã‚Šã—ã¾ã™ã€‚ã€Œæ¥½è¦³çš„æ›´æ–°ã®æ¦‚å¿µã¯ã‚ã‹ã‚‹ã‘ã©ã€å®Ÿéš›ã©ã†æ›¸ãã®ï¼Ÿã€ã¨ã„ã†ç–‘å•ã«å¯¾ã—ã¦ã€**Createï¼ˆè¿½åŠ ï¼‰ãƒ»Updateï¼ˆæ›´æ–°ï¼‰ãƒ»Deleteï¼ˆå‰Šé™¤ï¼‰ãƒ»ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°**ã®4ã¤ã®å…·ä½“çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ç­”ãˆã¾ã™ã€‚

ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®ç’°å¢ƒä¸‹ã§ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œå³åº§ã«åæ˜ ã•ã‚Œã‚‹ã€ä½“é¨“ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ã€æœ¬ç•ªç’°å¢ƒã§å®Ÿè·µã—ã¦ã„ã‚‹å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

```mermaid
sequenceDiagram
    participant U as User
    participant C as Component
    participant Q as QueryClient
    participant A as API

    U->>C: ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    C->>Q: mutation.mutate()
    Q->>Q: onMutate (æ¥½è¦³çš„æ›´æ–°)
    Q-->>C: UIãŒå³åº§ã«åæ˜ 
    Q->>A: APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ

    alt æˆåŠŸ
        A-->>Q: ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        Q->>Q: onSettled (å†æ¤œè¨¼)
    else å¤±æ•—
        A-->>Q: ã‚¨ãƒ©ãƒ¼
        Q->>Q: onError (ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯)
        Q-->>C: å…ƒã®çŠ¶æ…‹ã«å¾©å…ƒ
    end
```

## TL;DR

- **æ¥½è¦³çš„æ›´æ–°ã®4ãƒ‘ã‚¿ãƒ¼ãƒ³**: é…åˆ—è¿½åŠ ãƒ»é…åˆ—è¦ç´ æ›´æ–°ãƒ»é…åˆ—è¦ç´ å‰Šé™¤ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°ã®onMutateå®Ÿè£…ä¾‹
- **Contextå‹å®‰å…¨æ€§**: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç®¡ç†ã‚’TypeScriptã§å‹å®‰å…¨ã«
- **TTLãƒ—ãƒªã‚»ãƒƒãƒˆ**: æ•°ç§’ï½ç„¡é™ã¾ã§ã€ç”¨é€”åˆ¥ã®staleTimeè¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°**: APIã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã®å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æˆ¦ç•¥

> ã“ã®è¨­è¨ˆã‚’å®Ÿè£…ã—ãŸç­‹ãƒˆãƒ¬è¨˜éŒ²ã‚¢ãƒ—ãƒª **Attain** ã‚’å…¬é–‹ä¸­ã€‚
> é›»æ³¢ã®æ‚ªã„ã‚¸ãƒ ã§ã‚‚å¿«é©ã«ä½¿ãˆã¾ã™ã€‚
> ğŸ‘‰ [ã‚¢ãƒ—ãƒªã‚’è¦‹ã‚‹](https://attain-app.com/lp)

---

## å‰æ: QueryClientã®è¨­å®š

ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®åŸºæœ¬è¨­å®šã¯[å‰å›ã®è¨˜äº‹](/blog/2025/modern-edge-tech-stack)ã§è§£èª¬ã—ã¾ã—ãŸã€‚ã“ã“ã§ã¯è¿½åŠ ã®TTLãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

```typescript
// apps/mobile/src/lib/query-client.ts
export const TTL = {
  /** 30ç§’ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆé€²è¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆï¼‰ */
  REALTIME: 30 * 1000,
  /** 5åˆ† - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
  SHORT: ONE_MINUTE * 5,
  /** 10åˆ† - å®‰å®šã—ãŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼‰ */
  MEDIUM: ONE_MINUTE * 10,
  /** 1æ™‚é–“ - å¤‰æ›´ãŒå°‘ãªã„ãƒ‡ãƒ¼ã‚¿ */
  LONG: ONE_HOUR,
  /** ç„¡é™ - ä¸å¤‰ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã‚«ã‚¿ãƒ­ã‚°ï¼‰ */
  STATIC: Infinity,
} as const;
```

ä½¿ç”¨ä¾‹ï¼š

```typescript
// ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºä¸€è¦§ï¼ˆä¸å¤‰ãƒ‡ãƒ¼ã‚¿ï¼‰
export const useExercises = () => {
  return useQuery({
    queryKey: ['exercises'],
    queryFn: fetchExercises,
    staleTime: TTL.STATIC, // æ°¸ä¹…ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  });
};
```

---

## ãƒ‘ã‚¿ãƒ¼ãƒ³1: é…åˆ—ã¸ã®ãƒ‡ãƒ¼ã‚¿è¿½åŠ ï¼ˆCreateï¼‰- ä¸€æ™‚IDã§å³åº§ã«UIåæ˜ 

ã‚»ãƒƒãƒˆã‚’è¿½åŠ ã™ã‚‹ä¾‹ã§ã™ã€‚**ä¸€æ™‚ID**ã‚’ç™ºè¡Œã—ã¦UIã‚’å³åº§ã«æ›´æ–°ã—ã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾Œã«æ­£å¼ãªãƒ‡ãƒ¼ã‚¿ã§åŒæœŸã—ã¾ã™ã€‚

```typescript
// apps/mobile/src/hooks/useWorkouts.ts
export const useAddSet = (sessionId: string) => {
  const queryClient = useQueryClient();

  return useMutation<
    SetResponse,
    Error,
    CreateWorkoutSet,
    { previousData: WorkoutResponse | undefined } // Contextå‹
  >({
    mutationFn: async (data: CreateWorkoutSet) => {
      const res = await apiFetch(`/api/workouts/${sessionId}/sets`, {
        method: 'POST',
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error('Failed to add set');
      return res.json();
    },

    // 1. æ¥½è¦³çš„æ›´æ–°: APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰ã«å®Ÿè¡Œ
    onMutate: async (newSet) => {
      // é€²è¡Œä¸­ã®ã‚¯ã‚¨ãƒªã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç«¶åˆã‚’é˜²ãï¼‰
      await queryClient.cancelQueries({ queryKey: ['workout', sessionId] });

      // ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
      const previousData = queryClient.getQueryData<WorkoutResponse>([
        'workout',
        sessionId,
      ]);

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¥½è¦³çš„ã«æ›´æ–°
      if (previousData) {
        const optimisticSet: WorkoutSetWithExercise = {
          id: `temp-${Date.now()}`, // ä¸€æ™‚IDï¼ˆå¾Œã§ã‚µãƒ¼ãƒãƒ¼ã®IDã«ç½®æ›ï¼‰
          sessionId,
          exerciseId: newSet.exerciseId,
          weightKg: newSet.weightKg,
          reps: newSet.reps,
          rir: newSet.rir ?? null,
          isWarmup: newSet.isWarmup ?? false,
          isFailed: newSet.isFailed ?? false,
          isPr: false,
          completedAt: new Date().toISOString(),
          // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Exerciseæƒ…å ±ã‚’å–å¾—
          exerciseNameKey:
            previousData.sessionExercises.find(
              (e) => e.exerciseId === newSet.exerciseId,
            )?.exerciseNameKey ?? '',
          exerciseEquipment: 'barbell',
          exerciseCategory: 'chest',
        };

        queryClient.setQueryData<WorkoutResponse>(['workout', sessionId], {
          ...previousData,
          workoutSets: [...previousData.workoutSets, optimisticSet],
        });
      }

      // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¿”ã™
      return { previousData };
    },

    // 2. ã‚¨ãƒ©ãƒ¼æ™‚: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    onError: (_err, _newSet, context) => {
      if (context?.previousData) {
        queryClient.setQueryData(['workout', sessionId], context.previousData);
      }
    },

    // 3. å®Œäº†æ™‚: ã‚µãƒ¼ãƒãƒ¼ã®æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã§åŒæœŸ
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['workout', sessionId] });
    },
  });
};
```

### ãƒã‚¤ãƒ³ãƒˆ

1. **ä¸€æ™‚ID**: `temp-${Date.now()}` ã§UIè¡¨ç¤ºç”¨ã®IDã‚’ç™ºè¡Œ
2. **Exerciseæƒ…å ±**: æ—¢å­˜ã®ã‚»ãƒƒãƒˆã¾ãŸã¯sessionExercisesã‹ã‚‰å–å¾—
3. **onSettled**: æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšã€æœ€çµ‚çš„ã«ã‚µãƒ¼ãƒãƒ¼ã¨åŒæœŸ

---

## ãƒ‘ã‚¿ãƒ¼ãƒ³2: é…åˆ—å†…ã®è¦ç´ æ›´æ–°ï¼ˆUpdateï¼‰- map()ã§è©²å½“è¦ç´ ã‚’ç½®æ›

æ—¢å­˜ã®ã‚»ãƒƒãƒˆã‚’æ›´æ–°ã™ã‚‹ä¾‹ã§ã™ã€‚**è©²å½“è¦ç´ ã®ã¿ã‚’å·®ã—æ›¿ãˆ**ã¾ã™ã€‚

```typescript
type UpdateSetInput = {
  setId: string;
  weightKg?: number;
  reps?: number;
  rir?: number;
  isWarmup?: boolean;
  isFailed?: boolean;
};

export const useUpdateSet = (sessionId: string) => {
  const queryClient = useQueryClient();

  return useMutation<
    SetResponse,
    Error,
    UpdateSetInput,
    { previousData: WorkoutResponse | undefined }
  >({
    mutationFn: async (data: UpdateSetInput) => {
      const { setId, ...updateData } = data;
      const res = await apiFetch(`/api/workouts/${sessionId}/sets/${setId}`, {
        method: 'PATCH',
        body: JSON.stringify(updateData),
      });
      if (!res.ok) throw new Error('Failed to update set');
      return res.json();
    },

    onMutate: async (updatedSet) => {
      await queryClient.cancelQueries({ queryKey: ['workout', sessionId] });
      const previousData = queryClient.getQueryData<WorkoutResponse>([
        'workout',
        sessionId,
      ]);

      if (previousData) {
        // è©²å½“ã‚»ãƒƒãƒˆã®ã¿ã‚’mapã§æ›´æ–°
        queryClient.setQueryData<WorkoutResponse>(['workout', sessionId], {
          ...previousData,
          workoutSets: previousData.workoutSets.map((set) =>
            set.id === updatedSet.setId
              ? {
                  ...set,
                  weightKg: updatedSet.weightKg ?? set.weightKg,
                  reps: updatedSet.reps ?? set.reps,
                  rir: updatedSet.rir ?? set.rir,
                  isWarmup: updatedSet.isWarmup ?? set.isWarmup,
                  isFailed: updatedSet.isFailed ?? set.isFailed,
                }
              : set,
          ),
        });
      }

      return { previousData };
    },

    onError: (_err, _updatedSet, context) => {
      if (context?.previousData) {
        queryClient.setQueryData(['workout', sessionId], context.previousData);
      }
    },

    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['workout', sessionId] });
    },
  });
};
```

### ãƒã‚¤ãƒ³ãƒˆ

1. **éƒ¨åˆ†æ›´æ–°**: `updatedSet.weightKg ?? set.weightKg` ã§æœªæŒ‡å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ—¢å­˜å€¤ã‚’ç¶­æŒ
2. **mapé–¢æ•°**: è©²å½“IDã®ã¿æ›´æ–°ã€ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾è¿”ã™

---

## ãƒ‘ã‚¿ãƒ¼ãƒ³3: é…åˆ—ã‹ã‚‰è¦ç´ ã‚’å‰Šé™¤ï¼ˆDeleteï¼‰- filter()ã§å¯¾è±¡ã‚’é™¤å¤–

ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã™ã‚‹ä¾‹ã§ã™ã€‚**filterã§è©²å½“è¦ç´ ã‚’é™¤å¤–**ã—ã¾ã™ã€‚

```typescript
export const useDeleteSet = (sessionId: string) => {
  const queryClient = useQueryClient();

  return useMutation<
    DeleteResponse,
    Error,
    string, // setId
    { previousData: WorkoutResponse | undefined }
  >({
    mutationFn: async (setId: string) => {
      const res = await apiFetch(`/api/workouts/${sessionId}/sets/${setId}`, {
        method: 'DELETE',
      });
      if (!res.ok) throw new Error('Failed to delete set');
      return res.json();
    },

    onMutate: async (setId) => {
      await queryClient.cancelQueries({ queryKey: ['workout', sessionId] });
      const previousData = queryClient.getQueryData<WorkoutResponse>([
        'workout',
        sessionId,
      ]);

      if (previousData) {
        // filterã§è©²å½“ã‚»ãƒƒãƒˆã‚’é™¤å¤–
        queryClient.setQueryData<WorkoutResponse>(['workout', sessionId], {
          ...previousData,
          workoutSets: previousData.workoutSets.filter(
            (set) => set.id !== setId,
          ),
        });
      }

      return { previousData };
    },

    onError: (_err, _setId, context) => {
      if (context?.previousData) {
        queryClient.setQueryData(['workout', sessionId], context.previousData);
      }
    },

    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['workout', sessionId] });
    },
  });
};
```

### ãƒã‚¤ãƒ³ãƒˆ

1. **filteré–¢æ•°**: å‰Šé™¤å¯¾è±¡ä»¥å¤–ã‚’æ®‹ã™
2. **å¼•æ•°ã®å‹**: `string`ï¼ˆsetIdã®ã¿ï¼‰ã§ã‚·ãƒ³ãƒ—ãƒ«ã«

---

## ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®æ›´æ–° - Computed propertyã§å‹•çš„ã‚­ãƒ¼ã‚’è¨­å®š

ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºåˆ¥ã®RPEï¼ˆä¸»è¦³çš„é‹å‹•å¼·åº¦ï¼‰ã‚’æ›´æ–°ã™ã‚‹ä¾‹ã€‚**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‹•çš„ã«æ›´æ–°**ã—ã¾ã™ã€‚é…åˆ—ã§ã¯ãªãã€è¾æ›¸å‹ï¼ˆã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼ãƒšã‚¢ï¼‰ã®æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

```typescript
type SetExerciseRpeInput = {
  exerciseId: string;
  rpe: number;
};

export const useSetExerciseRpe = (sessionId: string) => {
  const queryClient = useQueryClient();

  return useMutation<
    SetExerciseRpeResponse,
    Error,
    SetExerciseRpeInput,
    { previousData: WorkoutResponse | undefined }
  >({
    mutationFn: async (data) => {
      const res = await apiFetch(
        `/api/workouts/${sessionId}/exercises/${data.exerciseId}/rpe`,
        {
          method: 'PUT',
          body: JSON.stringify({ rpe: data.rpe }),
        },
      );
      if (!res.ok) throw new Error('Failed to set exercise RPE');
      return res.json();
    },

    onMutate: async (data) => {
      await queryClient.cancelQueries({ queryKey: ['workout', sessionId] });
      const previousData = queryClient.getQueryData<WorkoutResponse>([
        'workout',
        sessionId,
      ]);

      if (previousData) {
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‹•çš„ã«æ›´æ–°
        queryClient.setQueryData<WorkoutResponse>(['workout', sessionId], {
          ...previousData,
          exerciseRpes: {
            ...previousData.exerciseRpes,
            [data.exerciseId]: data.rpe, // Computed property
          },
        });
      }

      return { previousData };
    },

    onError: (_err, _data, context) => {
      if (context?.previousData) {
        queryClient.setQueryData(['workout', sessionId], context.previousData);
      }
    },

    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['workout', sessionId] });
    },
  });
};
```

### ãƒã‚¤ãƒ³ãƒˆ

1. **Computed property**: `[data.exerciseId]: data.rpe` ã§å‹•çš„ã‚­ãƒ¼ã‚’è¨­å®š
2. **ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ¼”ç®—å­**: æ—¢å­˜ã®RPEè¨­å®šã‚’ä¿æŒã—ã¤ã¤ã€è©²å½“ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã®ã¿æ›´æ–°

---

## é«˜åº¦ãªãƒˆãƒ”ãƒƒã‚¯: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥

[å‰å›ã®è¨˜äº‹](/blog/2025/modern-edge-tech-stack)ã§ã€Œå°†æ¥çš„ã«å¯¾ç­–äºˆå®šã€ã¨æ›¸ã„ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’ã€å®Ÿéš›ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

æœ¬ç•ªç’°å¢ƒã§ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã®ä¸æ•´åˆã‚’é˜²ããŸã‚ã®ã€**å¿…é ˆã®ä»•çµ„ã¿**ã§ã™ã€‚

### å•é¡Œ: Hydration Error

APIã®å‹å®šç¾©ãŒå¤‰ã‚ã‚‹ã¨ã€å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã‚“ã éš›ã«ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```text
TypeError: Cannot read property 'exerciseId' of undefined
```

### è§£æ±º: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ãã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼

```typescript
// apps/mobile/src/lib/query-client.ts

/**
 * Cache Version
 *
 * WHEN TO BUMP:
 * - Breaking API schema changes
 * - Query key structure changes
 * - Major React Query upgrades
 */
export const CACHE_VERSION = 1;
export const QUERY_CACHE_KEY = `ATTAIN_QUERY_CACHE_v${CACHE_VERSION}`;

export const asyncStoragePersister = createAsyncStoragePersister({
  storage: AsyncStorage,
  key: QUERY_CACHE_KEY, // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ãã‚­ãƒ¼
  throttleTime: 3000,
});
```

### å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```typescript
// apps/mobile/src/components/QueryProvider.tsx

async function cleanupOldCaches(): Promise<void> {
  const allKeys = await AsyncStorage.getAllKeys();
  const cacheKeys = allKeys.filter(
    (key) =>
      key.startsWith("ATTAIN_QUERY_CACHE_v") &&
      key !== QUERY_CACHE_KEY // ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»¥å¤–
  );

  if (cacheKeys.length > 0) {
    await AsyncStorage.multiRemove(cacheKeys);
    console.log(`Cleaned up ${cacheKeys.length} old cache versions`);
  }
}

export const QueryProvider = ({ children }) => {
  return (
    <PersistQueryClientProvider
      client={queryClient}
      persistOptions={persistOptions}
      onSuccess={cleanupOldCaches} // å¾©å…ƒå¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    >
      {children}
    </PersistQueryClientProvider>
  );
};
```

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

| å¤‰æ›´å†…å®¹                                  | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ— |
| ----------------------------------------- | ---------------- |
| APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆoptionalï¼‰ | ä¸è¦             |
| APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤             | **å¿…è¦**         |
| APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹å¤‰æ›´ï¼ˆstringâ†’numberç­‰ï¼‰  | **å¿…è¦**         |
| ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã®æ§‹é€ å¤‰æ›´                      | **å¿…è¦**         |
| React Queryã®ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰       | **å¿…è¦**         |

---

## å®Ÿè£…ã‚¬ã‚¤ãƒ‰: ãƒ‘ã‚¿ãƒ¼ãƒ³æ—©è¦‹è¡¨

| æ“ä½œ                 | onMutateå†…ã®å‡¦ç†          | é…åˆ—æ“ä½œ                                                      |
| -------------------- | ------------------------- | ------------------------------------------------------------- |
| **è¿½åŠ **             | ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã§æœ«å°¾ã«è¿½åŠ     | `[...prev, newItem]`                                          |
| **æ›´æ–°**             | mapã§è©²å½“è¦ç´ ã‚’å·®ã—æ›¿ãˆ   | `.map(item => item.id === id ? {...item, ...updates} : item)` |
| **å‰Šé™¤**             | filterã§è©²å½“è¦ç´ ã‚’é™¤å¤–    | `.filter(item => item.id !== id)`                             |
| **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°** | Computed propertyã§ä¸Šæ›¸ã | `{ ...prev, [key]: value }`                                   |

æ¥½è¦³çš„æ›´æ–°ã¯ã€åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¹°ã‚Šè¿”ã—ã§ã™ã€‚ä¸€åº¦ç†è§£ã™ã‚Œã°ã€ã‚ã‚‰ã‚†ã‚‹CRUDæ“ä½œã«é©ç”¨ã§ãã¾ã™ã€‚

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ã“ã‚Œã‚‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ãŸã‚¢ãƒ—ãƒª

ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸæ¥½è¦³çš„æ›´æ–°ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥ã¯ã€ã™ã¹ã¦å…¬é–‹ä¸­ã®ç­‹ãƒˆãƒ¬è¨˜éŒ²ã‚¢ãƒ—ãƒª **Attain** ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãªãœã“ã®è¨­è¨ˆãŒå¿…è¦ãªã®ã‹

å®Ÿå‹™ã§é­é‡ã™ã‚‹èª²é¡Œï¼š

| èª²é¡Œ                     | Attainã§ã®è§£æ±ºæ–¹æ³•                            |
| ------------------------ | --------------------------------------------- |
| ä½é€Ÿãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆã‚¸ãƒ ï¼‰ | 7æ—¥é–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿æŒ + æ¥½è¦³çš„æ›´æ–°ã§0msã®åå¿œ |
| APIä»•æ§˜ã®å¤‰æ›´            | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã§è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—  |
| æ•°ç™¾è¡Œã®ã‚³ãƒ¼ãƒ‰é‡è¤‡       | CRUDã®4ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å…¨ã¦ã‚«ãƒãƒ¼                   |
| UIã®é…å»¶åæ˜              | onMutateã§å³åº§ã«Stateæ›´æ–°                     |

### å®Ÿéš›ã«å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª

- **PWAå¯¾å¿œ** - ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œ
- **å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè·µ** - è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾æ´»ç”¨å¯èƒ½
- **ç„¡æ–™ã§è©¦ã™** - ã‚³ã‚¢æ©Ÿèƒ½ã¯å®Œå…¨ç„¡æ–™

ğŸ‘‰ **[Attainã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦ã™](https://attain-app.com/lp)**

---

è³ªå•ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ [X (@paveg\_)](https://x.com/paveg_) ã¾ã§ï¼
