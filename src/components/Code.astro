---
const props = Astro.props;
---

<figure class="code-block" {...props}>
  <button
    class="copy-button"
    aria-label="コードをコピー"
    title="コードをコピー"
  >
    <svg
      class="copy-icon"
      xmlns="http://www.w3.org/2000/svg"
      width="14"
      height="14"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1.5"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
    </svg>
    <svg
      class="check-icon"
      xmlns="http://www.w3.org/2000/svg"
      width="14"
      height="14"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1.5"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    <span class="copy-text">Copy</span>
  </button>
  <slot />
</figure>

<script>
  function initCopyButtons() {
    document.querySelectorAll('figure.code-block').forEach((figure) => {
      const button = figure.querySelector('.copy-button');
      const pre = figure.querySelector('pre');

      if (!button || !pre) return;

      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        if (!code) return;

        // Get text content, removing line numbers
        const lines = code.querySelectorAll('[data-line]');
        let text = '';
        if (lines.length > 0) {
          lines.forEach((line) => {
            text += line.textContent + '\n';
          });
          text = text.trimEnd();
        } else {
          text = code.textContent || '';
        }

        try {
          await navigator.clipboard.writeText(text);
          button.classList.add('copied');
          setTimeout(() => {
            button.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  // Run on initial load
  initCopyButtons();

  // Re-run after Astro page transitions
  document.addEventListener('astro:after-swap', initCopyButtons);
</script>

<style>
  /* ═══════════════════════════════════════════════════════
     Minimal Terminal Code Block
     Design: Unified container with clear boundaries
     Uses dedicated code color variables for both modes
     WCAG AA compliant (contrast ratio >= 4.5:1 for text)
     ═══════════════════════════════════════════════════════ */

  figure {
    @apply relative my-6 overflow-hidden text-sm;
    font-family: var(--font-code);
    background: var(--code-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;

    /* Copy button - positioned inside the container */
    .copy-button {
      @apply absolute right-3 z-10 flex items-center gap-1.5 px-2.5 py-1.5 text-xs transition-all;
      top: 0.625rem; /* Align with title bar content */
      color: var(--code-title);
      background: var(--code-title-bg);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;

      &:hover {
        background: var(--code-hl);
      }

      &:focus-visible {
        outline: 2px solid var(--color-primary);
        outline-offset: 2px;
      }

      .copy-text {
        @apply font-medium;
      }

      .check-icon {
        @apply hidden;
      }

      &.copied {
        color: var(--color-primary);
        border-color: var(--color-primary);

        .copy-icon {
          @apply hidden;
        }
        .check-icon {
          @apply block;
        }
        .copy-text::after {
          content: 'ied';
        }
        .copy-text {
          &::before {
            content: 'Cop';
          }
        }
      }

      &.copied .copy-text {
        &::before {
          content: none;
        }
        &::after {
          content: none;
        }
      }
    }

    /* Code title bar - with space for copy button */
    :global([data-rehype-pretty-code-title]) {
      @apply block py-2.5 text-xs font-medium;
      padding-left: 1rem;
      padding-right: 5rem; /* Reserve space for copy button */
      color: var(--code-title);
      background: var(--code-title-bg);
      border-bottom: 1px solid var(--color-border);
      letter-spacing: 0.04em;
      text-transform: none;
    }

    /* Language badge - shown when no title */
    :global(pre[data-language])::before {
      content: attr(data-language);
      @apply absolute left-3 top-2.5 text-2xs font-medium uppercase;
      color: var(--color-muted-foreground);
      letter-spacing: 0.06em;
    }

    /* Hide language badge when title is present */
    :global([data-rehype-pretty-code-title])
      + :global(pre[data-language])::before {
      display: none;
    }

    /* Pre element */
    :global(pre) {
      @apply relative overflow-x-auto px-0;
      padding-top: 2rem; /* Space for language badge */
      padding-bottom: 1rem;
      margin: 0;
      background: transparent !important;
    }

    :global([data-rehype-pretty-code-title]) + :global(pre) {
      @apply py-3;
      padding-top: 0.75rem; /* No badge space needed when title present */
    }

    /* Code grid layout */
    :global(code) {
      counter-reset: line;
      @apply grid;
      background: transparent !important;

      :global([data-line]) {
        @apply px-4 leading-relaxed;
        min-height: 1.625rem;
      }

      /* Line numbers - WCAG AA compliant (opacity 0.5 for ~4.5:1 contrast) */
      > :global([data-line]::before) {
        counter-increment: line;
        content: counter(line);
        @apply mr-6 inline-block w-5 select-none text-right;
        color: var(--color-muted-foreground);
      }

      /* Highlighted lines */
      :global([data-highlighted-line]) {
        background: var(--code-hl);
        margin: 0 -1rem;
        padding: 0 1rem;

        :global(span) {
          background: unset;
        }
      }

      /* Highlighted characters */
      :global([data-highlighted-chars]) {
        @apply rounded px-1;
        background: var(--code-hl-sign);
        opacity: 0.2;

        :global(span) {
          background: unset;
        }
      }
    }
  }

  /* Syntax highlighting colors - light mode */
  :global(pre[data-theme*=' ']),
  :global(pre[data-theme*=' '] span) {
    color: var(--shiki-light);
    background: transparent !important;
  }

  /* Syntax highlighting colors - dark mode */
  :global(.dark pre[data-theme*=' ']),
  :global(.dark pre[data-theme*=' '] span) {
    color: var(--shiki-dark);
    background: transparent !important;
  }
</style>
