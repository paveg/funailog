---
import { ExternalLinkIcon, GitHubLogoIcon } from '@radix-ui/react-icons';

import type { SupportedLang } from '@/config/site';
import type { Project } from '@/schemas/portfolio-collection';

import { Badge } from '@/components/ui/badge';
import { useTranslations } from '@/i18n/utils';

interface Props {
  items: Project[];
  lang?: SupportedLang;
  initialVisibleCount?: number;
}

const { items, lang = 'ja', initialVisibleCount = 6 } = Astro.props;
const t = useTranslations(lang);
const hasHidden = items.length > initialVisibleCount;
const hiddenCount = items.length - initialVisibleCount;

const typeLabels: Record<Project['type'], Record<SupportedLang, string>> = {
  work: { ja: '業務', en: 'Work' },
  personal: { ja: '個人', en: 'Personal' },
  oss: { ja: 'OSS', en: 'OSS' },
};

const getAriaLabel = (name: string, type: 'site' | 'repo') => {
  if (lang === 'en') {
    return type === 'site' ? `Open ${name} website` : `Open ${name} repository`;
  }
  return type === 'site'
    ? `${name}のサイトを開く`
    : `${name}のリポジトリを開く`;
};

const showMoreLabel =
  lang === 'en' ? `+${hiddenCount} more` : `他 ${hiddenCount} 件`;
const collapseLabel = lang === 'en' ? 'Collapse' : '折りたたむ';
---

<section class="space-y-4 sm:space-y-5">
  <h2 class="font-heading text-lg font-semibold sm:text-xl">
    {t('portfolio.projects')}
  </h2>
  <div class="projects-grid grid gap-3 sm:grid-cols-2">
    {
      items.map((project, i) => (
        <div
          class:list={[
            'border-border/50 bg-card/50 group hover:border-border flex flex-col gap-2 rounded-lg border p-3 transition-all hover:shadow-sm sm:p-4',
            i >= initialVisibleCount && 'projects-hidden hidden',
          ]}
        >
          <div class="flex items-center justify-between gap-2">
            <div class="flex min-w-0 flex-wrap items-center gap-1.5 sm:gap-2">
              <span class="truncate text-sm font-medium sm:text-base">
                {project.name}
              </span>
              <Badge variant="default">{typeLabels[project.type][lang]}</Badge>
            </div>
            <div class="flex shrink-0 items-center gap-1">
              {project.url && (
                <a
                  href={project.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-muted-foreground hover:bg-accent hover:text-foreground rounded-md p-1 transition-colors"
                  aria-label={getAriaLabel(project.name, 'site')}
                >
                  <ExternalLinkIcon className="size-3.5 sm:size-4" />
                </a>
              )}
              {project.repository && (
                <a
                  href={project.repository}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-muted-foreground hover:bg-accent hover:text-foreground rounded-md p-1 transition-colors"
                  aria-label={getAriaLabel(project.name, 'repo')}
                >
                  <GitHubLogoIcon className="size-3.5 sm:size-4" />
                </a>
              )}
            </div>
          </div>
          <p class="text-muted-foreground text-xs leading-relaxed sm:text-sm">
            {project.description}
          </p>
          <div class="flex flex-wrap gap-1 sm:gap-1.5">
            {project.techStack.slice(0, 5).map((tech) => (
              <Badge variant="tech">{tech}</Badge>
            ))}
            {project.techStack.length > 5 && (
              <span class="text-muted-foreground/60 text-2xs px-1 py-0.5 sm:text-xs">
                +{project.techStack.length - 5}
              </span>
            )}
          </div>
        </div>
      ))
    }
  </div>
  {
    hasHidden && (
      <button
        type="button"
        class="projects-toggle font-code text-muted-foreground hover:text-foreground mx-auto flex items-center gap-1.5 text-xs transition-colors"
        data-show={showMoreLabel}
        data-hide={collapseLabel}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="projects-toggle-icon size-3 transition-transform"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="6 9 12 15 18 9" />
        </svg>
        <span class="projects-toggle-label">{showMoreLabel}</span>
      </button>
    )
  }
</section>

<script>
  function initProjectsToggle() {
    const btn = document.querySelector('.projects-toggle');
    if (!btn) return;

    let expanded = false;

    btn.addEventListener('click', () => {
      expanded = !expanded;
      const items = document.querySelectorAll('.projects-hidden');
      const label = btn.querySelector('.projects-toggle-label');
      const icon = btn.querySelector('.projects-toggle-icon');

      items.forEach((el) => el.classList.toggle('hidden', !expanded));

      if (label) {
        label.textContent = expanded
          ? (btn.getAttribute('data-hide') ?? '')
          : (btn.getAttribute('data-show') ?? '');
      }
      if (icon instanceof HTMLElement) {
        icon.style.transform = expanded ? 'rotate(180deg)' : '';
      }
    });
  }

  initProjectsToggle();
  document.addEventListener('astro:after-swap', initProjectsToggle);
</script>
