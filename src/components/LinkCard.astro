---
import { ExternalLinkIcon } from '@radix-ui/react-icons';

import { fetchLinkCard } from '@/lib/api';

export type Props = {
  href: string;
};

const props = Astro.props;

const { title, description, image } = await fetchLinkCard(props.href);
const isInternal = props.href.startsWith('/');
const isAnchor = props.href.startsWith('#');
const hostname = new URL(props.href).hostname;
const faviconUrl = `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`;
---

{
  title === 'Access Denied' ? (
    <a
      target="_blank"
      rel="noopener noreferrer"
      href={props.href}
      class="inline-flex items-center gap-1 text-link hover:text-link-hover hover:underline"
    >
      <slot />
      <ExternalLinkIcon className="size-3" />
    </a>
  ) : (
    <a
      {...props}
      target={isAnchor || isInternal ? '_self' : '_blank'}
      rel={isAnchor || isInternal ? '' : 'noopener noreferrer'}
      class="not-prose group block"
    >
      <div class="hover:border-primary/30 overflow-hidden rounded-lg border border-border bg-card transition-all duration-fast hover:shadow-sm sm:flex sm:flex-row">
        {/* Content Section */}
        <div class="flex flex-1 flex-col justify-center gap-1 overflow-hidden p-3">
          <span class="line-clamp-2 text-sm font-medium leading-snug text-foreground transition-colors group-hover:text-primary sm:line-clamp-1">
            {title}
          </span>
          {description && (
            <span class="line-clamp-2 text-xs leading-relaxed text-muted-foreground sm:line-clamp-1">
              {description}
            </span>
          )}
          <span class="flex items-center gap-1.5 text-xs text-muted-foreground">
            <img
              src={faviconUrl}
              alt=""
              width="14"
              height="14"
              class="m-0 size-3.5 shrink-0 rounded-sm"
              loading="lazy"
            />
            <span class="truncate">{hostname}</span>
            {!isInternal && !isAnchor && (
              <ExternalLinkIcon className="size-3 shrink-0 opacity-50" />
            )}
          </span>
        </div>
        {/* Image Section - Hidden on mobile, shown on desktop */}
        {image.src && (
          <div class="hidden w-[140px] shrink-0 border-l border-border bg-muted sm:flex sm:items-center sm:justify-center">
            <img
              class="m-0 max-h-full max-w-full object-contain"
              src={image.src}
              alt=""
              loading="lazy"
            />
          </div>
        )}
      </div>
    </a>
  )
}
