---
import { CalendarIcon, ReloadIcon } from '@radix-ui/react-icons';

import type { UnifiedPost } from '@/types/unified-post';

import { Badge } from '@/components/ui/badge';
import { formatDateEn } from '@/lib/utils';

export type Props = {
  post: UnifiedPost;
  variant?: 'card' | 'list';
};

const { post, variant = 'list' } = Astro.props;

// Get heroImage from originalPost if available, or use Satori-generated OG image
const heroImage =
  post.originalPost?.data.heroImage ??
  (post.collection && post.slug
    ? `/api/og/article/${post.collection}/${post.slug}.png`
    : undefined);

// Determine variant: use card if variant is card (now always has heroImage fallback)
const effectiveVariant = variant === 'card' && heroImage ? 'card' : 'list';

// Compare only the date portion to ignore time differences
const dateOnly = post.date.toISOString().slice(0, 10);
const lastUpdatedOnly = post.lastUpdated?.toISOString().slice(0, 10);
const hasDistinctUpdate = !!lastUpdatedOnly && lastUpdatedOnly !== dateOnly;
---

{
  effectiveVariant === 'card' ? (
    <article class="group">
      <a href={post.url} class="block">
        <div class="overflow-hidden rounded-lg border border-border bg-card transition-shadow duration-200 hover:shadow-md">
          {/* Hero Image */}
          {heroImage && (
            <div class="aspect-[16/9] overflow-hidden bg-muted">
              <img
                src={heroImage}
                alt=""
                class="size-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
              />
            </div>
          )}
          {/* Content */}
          <div class="p-4">
            <div class="mb-2 flex items-center gap-2">
              <Badge variant="secondary" className="capitalize">
                {post.category}
              </Badge>
              <span class="flex items-center gap-1 text-xs text-muted-foreground">
                <CalendarIcon className="size-3" />
                <time datetime={post.date.toISOString()}>
                  {formatDateEn(post.date)}
                </time>
                {hasDistinctUpdate && post.lastUpdated && (
                  <>
                    <ReloadIcon className="ml-1 size-3" />
                    <time datetime={post.lastUpdated.toISOString()}>
                      {formatDateEn(post.lastUpdated)}
                    </time>
                  </>
                )}
              </span>
            </div>
            <h3 class="line-clamp-2 font-heading text-lg text-foreground transition-colors duration-150 group-hover:text-link">
              {post.title}
            </h3>
            {post.description && (
              <p class="mt-2 line-clamp-2 text-sm text-muted-foreground">
                {post.description}
              </p>
            )}
          </div>
        </div>
      </a>
    </article>
  ) : (
    <article class="group">
      <a href={post.url} class="block">
        <div class="flex items-start gap-3">
          <div class="flex-1">
            <div class="mb-1 flex items-center gap-2">
              <Badge variant="secondary" className="capitalize">
                {post.category}
              </Badge>
              <span class="flex items-center gap-1 text-xs text-muted-foreground">
                <CalendarIcon className="size-3" />
                <time datetime={post.date.toISOString()}>
                  {formatDateEn(post.date)}
                </time>
                {hasDistinctUpdate && post.lastUpdated && (
                  <>
                    <ReloadIcon className="ml-1 size-3" />
                    <time datetime={post.lastUpdated.toISOString()}>
                      {formatDateEn(post.lastUpdated)}
                    </time>
                  </>
                )}
              </span>
            </div>
            <h3 class="font-heading text-foreground transition-colors duration-150 group-hover:text-link">
              {post.title}
            </h3>
          </div>
        </div>
      </a>
    </article>
  )
}
